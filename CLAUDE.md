# 角色扮演AI对话平台 - 开发规约

## 1. 核心开发原则

### 1.1 代码修改原则

- **单一职责原则** - 每个服务、方法只负责一个明确的职责域
- **最简代码原则** - 不做向后兼容，宁愿破坏性更新也要保证代码最简化
- **类型严格原则** - 所有TypeScript类型必须正确，不使用any
- **KISS原则** - 保持简单直接，如果需要解释就是太复杂了
- **文档置信度原则** - 绝不基于推测写代码，必须基于真实可验证的技术文档

### 1.2 任务执行流程

1. **修改前说明** - 每次修改任何文件前，说明修改原因和遵循的原则
2. **完整阅读** - 完整阅读所有相关文件，识别功能重叠
3. **编译优先** - 每次修改后立即检查编译
4. **功能检查** - 修改后检查是否有重复功能

### 1.3 工具使用质量保证规范

#### 核心原则

**操作后立即验证，永不盲目批量**

- 任何文件操作 = 执行 + 立即验证 + 确认无误
- 批量操作必须分批验证，不允许创建10+文件后才检查
- 发现错误立即停止，分析修复后再继续

#### Write工具规范

**参数格式检查：**
- content必须是 `[{"text": "纯文本内容", "type": "text"}]`
- text字段内不能有JSON嵌套（不能出现 `[{"`、`\"`、`\\n` 等）
- 文件路径必须是绝对路径

**立即验证（必须执行）：**
- Write后立即Read前5-10行
- 确认文件第一行符合文件类型：
  - TypeScript: `import`/`export`/`class`/`interface` 开头
  - Vue: `<template>`/`<script>` 开头
  - JSON: `{` 开头（不是 `[{"`）
  - HTML: `<!DOCTYPE` 开头
  - Shell: `#!/bin/bash` 开头

**错误信号识别：**
- ❌ 文件开头是 `[{"text":`  → JSON嵌套错误，立即重写
- ❌ 文件内容有转义符 `\"`、`\\n` → 格式错误，立即重写
- ❌ TypeScript文件不是代码关键字开头 → 内容错误，检查

#### Edit工具规范

**操作前（必须执行）：**
- 必须先Read整个文件或相关部分
- 确认old_string在文件中存在且唯一
- 确认new_string与old_string不同

**操作后（必须执行）：**
- 立即Read修改区域±5行
- 确认old_string已被替换
- 确认new_string正确插入
- 确认缩进和格式保持一致

**禁止行为：**
- ❌ 不Read文件就Edit
- ❌ 连续多次Edit不验证

#### Bash工具规范

**操作后（必须执行）：**
- 检查exit code是否为0
- 检查输出内容是否符合预期
- 如果是文件操作，用ls/cat验证结果
- 如果是安装操作，验证包是否安装成功

**错误处理：**
- exit code ≠ 0 → 立即停止，分析错误
- 输出包含error/failed → 立即停止，不继续后续操作
- Permission denied → 检查权限，使用正确命令

#### 批量操作规范

**渐进式验证（强制执行）：**
```
创建第1个文件 → Read验证 → 继续创建4个 → 抽查2个验证
→ 继续创建5个 → 抽查2个验证 → 确认模式正确
→ 创建剩余 → 最终抽查3-5个
```

**关键文件优先验证：**
- 入口文件：main.ts、index.ts、App.vue
- 配置文件：package.json、tsconfig.json、vite.config.ts
- 核心文件：Service、Controller、Module

**类型分离验证：**
- TypeScript文件一批 → 验证 → Vue文件一批 → 验证 → 配置文件一批 → 验证

#### 立即停止的错误信号

遇到以下情况必须立即停止当前操作：

| 信号 | 说明 | 处理 |
|------|------|------|
| 🔴 JSON嵌套 | 文件开头 `[{"text":` | 立即重写文件 |
| 🔴 命令失败 | exit code ≠ 0 | 分析错误，修复后重试 |
| 🔴 编译错误 | TypeScript报错 | 修复错误，重新编译 |
| 🔴 文件不存在 | No such file | 检查路径，确认文件存在 |
| 🔴 权限错误 | Permission denied | 检查权限，使用正确命令 |

#### 禁止行为清单

- ❌ 创建大量文件后才验证
- ❌ 看到错误继续执行
- ❌ 不读文件就Edit
- ❌ 不检查Bash命令输出
- ❌ 假设操作一定成功
- ❌ 批量操作不分批验证

#### 操作自检清单（每次操作前）

```
□ 这个操作是否需要验证？（99%都需要）
□ 如何验证这个操作成功？（提前想好）
□ 是否是批量操作？（必须分批验证）
□ 是否是关键文件？（加倍小心）
□ 失败了如何补救？（有备案）
```

## 2. 技术选型标准

### 2.1 后端技术选型

- **NestJS** - 企业级框架，完整的依赖注入和模块化架构
- **TypeORM** - 支持synchronize模式，无需migration
- **MySQL** - 关系型数据库，适合结构化数据
- **SSE** - 比WebSocket更简单，适合单向流式传输

### 2.2 前端技术选型

- **Vue 3 + Composition API** - 现代化组件开发
- **Element Plus** - 成熟稳定，组件丰富，避免重复造轮子
- **Pinia** - Vue 3官方推荐状态管理
- **VueUse** - 组合式函数工具库

### 2.3 选型原则

- 成熟度优先
- 社区活跃度高
- 学习曲线合理
- 维护成本低

## 3. 架构设计规范

### 3.1 分层架构

```
Controller层 - 处理HTTP请求，参数验证
    ↓
Service层 - 业务逻辑处理
    ↓
Repository层 - 数据库操作
```

### 3.2 关联关系处理

- **使用逻辑外键，不用物理外键**
- 业务层负责数据一致性
- 级联删除由代码控制
- 便于数据迁移和分库分表

### 3.3 状态管理

- **后端**: 无状态设计，所有状态存储在数据库
- **前端**: 使用Pinia管理全局状态

## 4. 数据库设计规范

### 4.1 命名规范

- **表名**: 小写+下划线+复数形式（如 `characters`, `messages`）
- **字段名**: 小写+下划线（如 `character_id`, `created_at`）
- **索引名**: `idx_表名_字段名`（如 `idx_messages_character_id`）
- **不使用MySQL保留字**

### 4.2 字段类型标准

| 用途     | 类型            | 说明           |
| -------- | --------------- | -------------- |
| 主键UUID | VARCHAR(36)     | 存储UUID字符串 |
| 短字符串 | VARCHAR(length) | 明确长度限制   |
| 长文本   | TEXT            | 超过255字符    |
| 时间     | DATETIME        | 推荐使用       |
| 布尔     | TINYINT(1)      | 0/1表示        |
| JSON     | JSON            | MySQL 5.7+     |

### 4.3 索引策略

- 主键自动创建索引
- 逻辑外键字段必须建索引
- 时间字段用于排序时建索引
- 联合索引按查询频率和选择性设计

### 4.4 字符集

- 统一使用 `utf8mb4` + `utf8mb4_unicode_ci`
- 支持emoji和多语言

## 5. API设计规范

### 5.1 RESTful规范

- **GET**: 查询资源
- **POST**: 创建资源
- **PUT**: 更新资源
- **DELETE**: 删除资源

### 5.2 URL命名

- 使用小写字母
- 使用中划线分隔（kebab-case）
- 资源使用复数形式
- 示例: `/api/characters/:id`

### 5.3 响应格式

```typescript
// 成功响应
{
  "success": true,
  "data": any
}

// 错误响应
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "用户友好的错误信息"
  }
}
```

### 5.4 HTTP状态码

- **200**: 成功
- **201**: 创建成功
- **400**: 客户端错误（参数错误）
- **404**: 资源不存在
- **500**: 服务器错误

## 6. 代码规范

### 6.1 TypeScript规范

- **不使用any类型**，必须明确类型
- 接口命名使用帕斯卡命名法
- 导出所有需要的类型定义

### 6.2 命名规范

- **变量/函数**: 驼峰命名（camelCase）
- **常量**: 大写+下划线（UPPER_SNAKE_CASE）
- **类名**: 帕斯卡命名（PascalCase）
- **文件名**: kebab-case.ts

### 6.3 代码组织

```typescript
// 1. 导入
import { ... } from '...';

// 2. 类型定义
interface/type/enum

// 3. 常量
const CONSTANTS = ...;

// 4. 类/函数实现
export class/function
```

## 7. 错误处理规范

### 7.1 异常分类

- **业务异常**: 用户操作导致（如资源不存在）
- **系统异常**: 服务器内部错误
- **第三方异常**: 外部API调用失败

### 7.2 用户提示规范

- 技术错误转换为友好提示
- 不暴露敏感信息（如数据库结构）
- 提供可操作的建议

### 7.3 日志记录

- ERROR级别: 系统异常
- WARN级别: 业务异常
- INFO级别: 关键操作
- DEBUG级别: 调试信息

## 8. 业务规则配置

### 8.1 数据限制

```typescript
const BUSINESS_RULES = {
  // 角色相关
  CHARACTER_NAME_MAX_LENGTH: 100,
  DESCRIPTION_MAX_LENGTH: 500,
  BACKGROUND_STORY_MAX_LENGTH: 2000,

  // 消息相关
  MESSAGE_MAX_LENGTH: 2000,
  HISTORY_LIMIT: 20,  // AI上下文历史消息数

  // 并发控制
  MAX_CONCURRENT_REQUESTS: 1,  // 同时只能有1个AI请求
};
```

### 8.2 预设数据

- 5个预设角色
- 系统自动初始化
- 不可删除（通过metadata标记）

## 9. 测试标准

### 9.1 单元测试

- Service层必须有单元测试
- 覆盖核心业务逻辑
- Mock外部依赖

### 9.2 集成测试

- API端点测试
- 数据库操作测试
- AI服务集成测试

### 9.3 验证标准

- 功能正确性
- TypeScript编译通过
- 无明显性能问题

## 10. 文档更新规范

### 10.1 文档分层

- **规约文档(CLAUDE.md)**: 开发标准和原则（本文档）
- **README.md**: 项目实现和使用说明

### 10.2 更新时机

- 功能完成后更新README
- 接口变更更新API文档
- 架构调整更新规约文档

## 11. Git规范

### 11.1 提交信息格式

```
<type>: <subject>

<body>
```

类型:

- **feat**: 新功能
- **fix**: 修复bug
- **docs**: 文档更新
- **refactor**: 重构
- **test**: 测试相关

### 11.2 分支管理

- **main**: 主分支，保持稳定
- **develop**: 开发分支
- **feature/***: 功能分支

## 12. 安全规范

### 12.1 敏感信息

- API密钥存储在.env文件
- .env文件不提交到Git
- 使用.env.example作为模板

### 12.2 输入验证

- 前端表单验证
- 后端DTO验证
- 防止SQL注入（使用ORM）

### 12.3 错误信息

- 不暴露数据库结构
- 不暴露文件路径
- 不暴露API密钥

## 13. 性能优化原则

### 13.1 数据库优化

- 为常用查询字段建索引
- 避免N+1查询问题
- 使用分页加载

### 13.2 前端优化

- 组件懒加载
- 图片懒加载
- 防抖和节流

### 13.3 API优化

- 流式传输（SSE）
- 压缩响应数据
- 缓存静态资源

## 14. MVP功能边界

### 14.1 包含功能 ✅

- 角色创建（简化4字段）
- 预设角色（5个）
- 角色删除
- 文本对话（流式）
- 单对话模式
- 清空对话

### 14.2 不包含功能 ❌

- 用户登录/注册
- 角色编辑
- 图片上传
- 多对话管理
- 对话导出
- 角色分享

### 14.3 后续迭代

- P1: 多对话支持、图片识图
- P2: 对话导出、角色分享

---

**版本**: v1.1
**更新日期**: 2026-02-13
**更新内容**: 新增"1.3 工具使用质量保证规范"，防止文件格式错误和批量操作风险
**适用项目**: 角色扮演AI对话平台
